<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hxdeck Task Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@16.1.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            /* Base colors */
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --modal-gradient: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%);
            --completed-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --menu-gradient: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%);
            
            /* Light theme */
            --bg-color-light: #f3f4f6;
            --text-color-light: #1f2937;
            --card-bg-light: #ffffff;
            --border-light: #e5e7eb;
            
            /* Dark theme */
            --bg-color-dark: #111827;
            --text-color-dark: #f9fafb;
            --card-bg-dark: #1f2937;
            --border-dark: #374151;
            --input-bg-dark: #374151;
            
            /* Dynamic theme (will be set by JS) */
            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --border-color: var(--border-light);
            
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-links a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }

        .add-task-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.3s;
        }

        .add-task-btn:hover {
            transform: scale(1.1);
        }

        .tasks-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .task-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Update task card styles */
        .task-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .task-card.completed {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .task-card.completed:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
        }

        .task-card.completed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                transparent 0%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 100%
            );
            transform: translateX(-100%);
            transition: transform 0.5s;
            pointer-events: none;
        }

        .task-card.completed:hover::before {
            transform: translateX(100%);
        }

        .task-card.completed .task-content,
        .task-card.completed .task-meta,
        .task-card.completed .task-actions button,
        .task-card.completed .due-date,
        .task-card.completed .recurring-icon,
        .task-card.completed .subtask-count {
            color: white;
        }

        .task-card.completed .task-checkbox {
            background-color: white;
            border-color: white;
        }

        .task-card.completed .task-checkbox:checked {
            background-color: white;
        }

        .task-card.completed .task-checkbox:checked::after {
            color: #059669;
            font-weight: bold;
        }

        .task-card.completed .delete-task-btn {
            color: rgba(255, 255, 255, 0.9);
        }

        .task-card.completed .delete-task-btn:hover {
            color: white;
        }

        .task-card .task-content {
            flex: 1;
            transition: all 0.3s;
        }

        .task-card.completed .task-content {
            text-decoration: line-through;
            opacity: 0.9;
        }

        /* Add gradient animation for completed cards */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .task-card.completed {
            background: linear-gradient(
                135deg,
                #34d399 0%,
                #059669 50%,
                #34d399 100%
            );
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }

        .task-card .title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .task-card .meta {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .task-card .due-date {
            color: var(--primary-color);
        }

        .progress-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar .progress {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--modal-gradient);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .subtasks {
            margin: 1rem 0;
        }

        .subtask-item {
            background: var(--menu-gradient);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .subtask-item:hover {
            transform: translateX(4px);
        }

        .subtask-item.completed {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }

        .subtask-item.completed input[type="checkbox"],
        .subtask-item.completed button {
            color: white;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            appearance: none;
            -webkit-appearance: none;
            background-color: var(--card-bg);
            position: relative;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .task-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        .task-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .delete-task-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.8;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-task-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .delete-task-btn i {
            font-size: 1.1rem;
        }

        .completed-task {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .restore-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.1rem;
        }

        .completed-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #eee;
        }

        .settings-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: transform 0.3s;
        }

        .settings-btn:hover {
            transform: rotate(45deg);
        }

        .recurring-options {
            background: var(--menu-gradient);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-color);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .recurring-details {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .recurring-type select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-size: 1rem;
            cursor: pointer;
        }

        .weekday-buttons {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .weekday-buttons label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
        }

        .weekday-buttons label:hover {
            background: rgba(74, 144, 226, 0.1);
        }

        .weekday-buttons label input[type="checkbox"] {
            margin: 0;
        }

        .monthly-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            cursor: pointer;
        }

        .settings-content {
            padding: 1rem 0;
        }

        .settings-content select {
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }

        .subtasks-list {
            margin-bottom: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        #status-message {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            box-shadow: var(--shadow);
            display: none;
        }

        .success {
            color: var(--success-color);
        }

        .error {
            color: var(--danger-color);
        }

        .task-card .task-content {
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .task-details-content {
            padding: 1rem 0;
        }

        .task-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .title-input {
            font-size: 1.5rem;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            padding: 0.5rem;
            flex: 1;
            margin-right: 1rem;
        }

        .title-input:focus {
            border-bottom-color: var(--primary-color);
            outline: none;
        }

        .description-input {
            width: 100%;
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-family: inherit;
        }

        .date-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        .subtasks-section {
            margin-top: 2rem;
        }

        .subtasks-section h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        .detail-subtask-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--menu-gradient);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            transition: all 0.3s;
        }

        .detail-subtask-item:hover {
            transform: translateX(4px);
        }

        .detail-subtask-item.completed {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }

        .detail-subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            appearance: none;
            -webkit-appearance: none;
            background-color: var(--card-bg);
            position: relative;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .detail-subtask-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .detail-subtask-item input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 12px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .detail-subtask-item input[type="text"] {
            flex: 1;
            padding: 0.25rem 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 1rem;
        }

        .detail-subtask-item input[type="text"]:focus {
            outline: none;
        }

        .detail-subtask-item .btn-danger {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0.5rem;
            opacity: 0.8;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-subtask-item .btn-danger:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .detail-subtask-item.completed input[type="checkbox"],
        .detail-subtask-item.completed input[type="text"],
        .detail-subtask-item.completed .btn-danger {
            color: white;
        }

        /* Dark mode adjustments */
        [data-theme="dark"] .detail-subtask-item {
            background: var(--input-bg);
        }

        [data-theme="dark"] .detail-subtask-item input[type="text"] {
            color: var(--text-color);
        }

        [data-theme="dark"] .detail-subtask-item .btn-danger {
            color: #fc8181;
        }

        .recurring-info {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--border-radius);
        }

        /* Dark mode styles */
        [data-theme="dark"] {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --card-bg: var(--card-bg-dark);
            --border-color: var(--border-dark);
            --input-bg: #2d3748;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --modal-bg: #1a2234;
        }

        /* Fix modal content background in dark mode */
        [data-theme="dark"] .modal-content {
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
        }

        /* Fix input backgrounds in dark mode */
        [data-theme="dark"] .title-input,
        [data-theme="dark"] .description-input {
            background: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        /* Fix modal header in dark mode */
        [data-theme="dark"] .modal-header h2 {
            color: var(--text-color);
        }

        /* Fix subtask items in dark mode */
        [data-theme="dark"] .subtask-item {
            background: var(--card-bg-dark);
        }

        [data-theme="dark"] .subtask-item input[type="text"] {
            background: transparent;
            color: var(--text-color);
        }

        /* Fix recurring options in dark mode */
        [data-theme="dark"] .recurring-options {
            background: var(--input-bg);
        }

        /* Fix weekday buttons in dark mode */
        [data-theme="dark"] .weekday-buttons label {
            background: var(--card-bg-dark);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .weekday-buttons label:hover {
            background: var(--input-bg);
        }

        /* Fix status message in dark mode */
        [data-theme="dark"] #status-message {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        /* Fix flatpickr in dark mode */
        [data-theme="dark"] .flatpickr-calendar {
            background: var(--modal-bg);
            border-color: var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-months,
        [data-theme="dark"] .flatpickr-calendar .flatpickr-weekday,
        [data-theme="dark"] .flatpickr-calendar .flatpickr-day {
            color: var(--text-color);
            background: transparent;
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-day:hover {
            background: var(--input-bg);
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-day.selected {
            background: var(--primary-gradient);
            color: white;
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-day.prevMonthDay,
        [data-theme="dark"] .flatpickr-calendar .flatpickr-day.nextMonthDay {
            color: #64748b;
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-current-month,
        [data-theme="dark"] .flatpickr-calendar .flatpickr-monthDropdown-months,
        [data-theme="dark"] .flatpickr-calendar .numInputWrapper input {
            color: var(--text-color);
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-monthDropdown-months,
        [data-theme="dark"] .flatpickr-calendar .numInputWrapper input {
            background: var(--input-bg);
        }

        /* Fix buttons in dark mode */
        [data-theme="dark"] .btn-secondary {
            background: #4a5568;
            color: white;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: #2d3748;
        }

        /* Improve transitions */
        .modal-content,
        .subtask-item,
        .recurring-options,
        .weekday-buttons label,
        input,
        textarea,
        select,
        button {
            transition: all 0.3s ease;
        }

        /* Add these new styles for dark mode compatibility */
        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .modal {
            background: var(--modal-overlay);
        }

        [data-theme="dark"] .close-modal {
            color: var(--text-color);
        }

        [data-theme="dark"] .task-card .meta {
            color: #a0aec0;
        }

        [data-theme="dark"] .delete-task-btn {
            color: #fc8181;
        }

        [data-theme="dark"] .task-checkbox {
            accent-color: #4f46e5;
        }

        [data-theme="dark"] .flatpickr-calendar {
            background: var(--card-bg);
            border-color: var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-months,
        [data-theme="dark"] .flatpickr-calendar .flatpickr-weekday,
        [data-theme="dark"] .flatpickr-calendar .flatpickr-day {
            color: var(--text-color);
            background: var(--card-bg);
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-day:hover {
            background: var(--input-bg);
        }

        [data-theme="dark"] .flatpickr-calendar .flatpickr-day.selected {
            background: var(--primary-gradient);
            color: white;
        }

        [data-theme="dark"] .detail-subtask-item {
            background: var(--input-bg);
        }

        [data-theme="dark"] .detail-subtask-item input[type="text"] {
            background: transparent;
            color: var(--text-color);
        }

        [data-theme="dark"] .recurring-options {
            background: var(--input-bg);
        }

        [data-theme="dark"] .weekday-buttons label {
            background: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .weekday-buttons label:hover {
            background: var(--input-bg);
        }

        [data-theme="dark"] #status-message {
            background: var(--card-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .success {
            color: #48bb78;
        }

        [data-theme="dark"] .error {
            color: #fc8181;
        }

        /* Add smooth transitions for all color changes */
        .modal-content,
        input,
        textarea,
        select,
        .task-card,
        .detail-subtask-item,
        .recurring-options,
        .weekday-buttons label {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        /* Fix input placeholder colors in dark mode */
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #718096;
        }

        /* Fix flatpickr time input in dark mode */
        [data-theme="dark"] .flatpickr-calendar input.numInput {
            color: var(--text-color);
            background: var(--input-bg);
        }

        .settings-modal {
            background: var(--menu-gradient);
        }

        .settings-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .settings-content select:hover {
            border-color: var(--primary-color);
        }

        .settings-content label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        /* Update the form styles in dark mode */
        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group textarea {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .form-group label {
            color: var(--text-color);
        }

        [data-theme="dark"] .subtask-item {
            background-color: var(--input-bg);
        }

        [data-theme="dark"] .subtask-item input[type="text"] {
            background-color: transparent;
            color: var(--text-color);
        }

        [data-theme="dark"] .modal-header h2 {
            color: var(--text-color);
        }

        /* Fix the add task button in dark mode */
        [data-theme="dark"] .add-task-btn {
            background: var(--primary-gradient);
            color: white;
        }

        /* Fix the modal background in dark mode */
        [data-theme="dark"] .modal-content {
            background-color: var(--modal-bg);
            border-color: var(--border-color);
        }

        /* Fix the close button in dark mode */
        [data-theme="dark"] .close-modal {
            color: var(--text-color);
        }

        /* Fix placeholder text in dark mode */
        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Improve button contrast in dark mode */
        [data-theme="dark"] .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        [data-theme="dark"] .btn-secondary {
            background: #4a5568;
            color: white;
        }

        [data-theme="dark"] .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        /* Add these styles for the logout button in settings */
        .settings-content .logout-btn {
            margin-top: 1.5rem;
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            background: var(--danger-gradient);
            color: white;
            transition: opacity 0.3s;
        }

        .settings-content .logout-btn:hover {
            opacity: 0.9;
        }

        .task-card .task-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .recurring-icon {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        [data-theme="dark"] .recurring-icon {
            color: var(--text-color-dark);
        }

        /* Add these styles */
        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .recurring-icon {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        [data-theme="dark"] .recurring-icon {
            color: var(--text-color-dark);
        }

        .task-header .title {
            margin-bottom: 0;
            margin-right: 0.5rem;
        }

        /* Add these styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.3s;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid var(--text-color);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading-text {
            color: var(--text-color);
            font-size: 1.1rem;
            font-weight: 500;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add these new styles */
        .theme-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .switch {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #374151;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Add CSS for disabled calendar */
        .flatpickr-calendar.disabled {
            pointer-events: none !important;
            background: var(--bg-color) !important;
            opacity: 0.6 !important;
        }
        
        .flatpickr-calendar.disabled .flatpickr-days,
        .flatpickr-calendar.disabled .flatpickr-months,
        .flatpickr-calendar.disabled .flatpickr-time {
            pointer-events: none !important;
            opacity: 0.6 !important;
            background: var(--bg-color) !important;
        }

        .flatpickr-calendar.disabled .flatpickr-day {
            color: #999 !important;
            cursor: not-allowed !important;
        }

        .flatpickr-calendar.disabled .flatpickr-day.selected {
            background: rgba(0, 0, 0, 0.1) !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
        }

        /* Update settings modal styles */
        .settings-modal {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .settings-modal h2 {
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .settings-content {
            padding: 1.5rem 0;
        }

        .settings-group {
            margin-bottom: 1.5rem;
        }

        .settings-group:last-child {
            margin-bottom: 0;
        }

        .settings-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-weight: 500;
        }

        #theme-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1em;
            padding-right: 2.5rem;
            transition: all 0.3s ease;
        }

        #theme-select:hover {
            border-color: var(--primary-color);
        }

        #theme-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Fix checkbox styles in create menu */
        .subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            appearance: none;
            background-color: var(--card-bg);
            position: relative;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .subtask-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .subtask-item input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 12px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Add logout button styles */
        .settings-content .logout-btn {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            background: var(--danger-gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-content .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2);
        }

        .settings-content .logout-btn:active {
            transform: translateY(0);
        }

        /* Add animation for settings modal */
        .settings-modal {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -48%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Add confetti styles */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #fff;
            opacity: 0;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes confetti-shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }

        .confetti.active {
            animation: confetti-fall 3s linear forwards, confetti-shake 2s ease-in-out infinite;
        }

        /* Add success animation for task completion */
        @keyframes success-pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
            100% {
                transform: scale(1);
            }
        }

        .task-card.completed {
            animation: success-pulse 0.5s ease-in-out;
        }

        /* Add this CSS for the fade out animation */
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Add styles for time-only mode */
        .flatpickr-calendar.time-only .flatpickr-days,
        .flatpickr-calendar.time-only .flatpickr-months,
        .flatpickr-calendar.time-only .flatpickr-weekdays {
            opacity: 0.5;
            pointer-events: none;
        }

        .flatpickr-calendar.time-only .flatpickr-time {
            border-top: none;
            opacity: 1;
            pointer-events: auto;
        }

        .flatpickr-calendar.time-only .numInputWrapper {
            pointer-events: auto;
            opacity: 1;
        }

        .flatpickr-calendar.time-only .flatpickr-time input,
        .flatpickr-calendar.time-only .flatpickr-time .flatpickr-am-pm {
            pointer-events: auto;
            opacity: 1;
            color: var(--text-color);
        }

        /* Add styles for time-only picker */
        .time-only-picker {
            width: auto !important;
            min-width: 150px !important;
        }

        .time-only-picker .flatpickr-time {
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin: 0;
            background: var(--card-bg);
        }

        .time-only-picker input.flatpickr-hour,
        .time-only-picker input.flatpickr-minute {
            color: var(--text-color);
            background: transparent;
        }

        .time-only-picker .flatpickr-time .flatpickr-time-separator {
            color: var(--text-color);
        }

        [data-theme="dark"] .time-only-picker .flatpickr-time {
            background: var(--input-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .time-only-picker input.flatpickr-hour,
        [data-theme="dark"] .time-only-picker input.flatpickr-minute {
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Loading tasks...</div>
    </div>
    <div class="confetti-container" id="confetti-container"></div>
    <div class="container">
        <header class="header">
            <h1>Hxdeck Task Manager</h1>
            <nav class="nav-links">
                <a href="index.html">Home</a>
                <a href="tasks.html">Tasks</a>
                <button class="settings-btn" onclick="openSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </nav>
        </header>

        <div class="task-section">
            <h2 class="section-title">Active Tasks</h2>
            <div id="active-tasks" class="tasks-container">
                <!-- Active tasks will be added here -->
            </div>
        </div>

        <div class="task-section">
            <h2 class="section-title">Completed Tasks</h2>
            <div id="completed-tasks" class="tasks-container">
                <!-- Completed tasks will be added here -->
            </div>
        </div>

        <button class="add-task-btn" onclick="openAddTaskModal()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Task</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <form id="task-form" onsubmit="handleTaskSubmit(event)">
                <div class="form-group">
                    <label for="task-title">Title</label>
                    <input type="text" id="task-title" required>
                </div>
                <div class="form-group">
                    <label for="task-description">Description</label>
                    <textarea id="task-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="due-date">Due Date</label>
                    <input type="text" id="due-date" class="flatpickr">
                </div>
                <div class="form-group">
                    <label>Subtasks</label>
                    <div id="subtasks-container" class="subtasks-list"></div>
                    <button type="button" class="btn btn-secondary" onclick="addSubtask()">
                        <i class="fas fa-plus"></i> Add Subtask
                    </button>
                </div>
                <div class="form-group">
                    <div class="recurring-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="is-recurring" onchange="toggleRecurringOptions()">
                            <span class="checkbox-text">Make this task recurring</span>
                        </label>
                        <div id="recurring-details" style="display: none;" class="recurring-details">
                            <div class="recurring-type">
                                <select id="recurring-type" onchange="handleRecurringTypeChange()">
                                    <option value="daily">Every Day</option>
                                    <option value="weekly">Every Week</option>
                                    <option value="monthly">Every Month</option>
                                </select>
                            </div>
                            
                            <div id="monthly-options" class="monthly-selector" style="display: none;">
                                <select id="monthly-day"></select>
                            </div>

                            <div id="weekly-options" class="weekday-selector" style="display: none;">
                                <div class="weekday-buttons">
                                    <label><input type="checkbox" value="0"><span>Sun</span></label>
                                    <label><input type="checkbox" value="1"><span>Mon</span></label>
                                    <label><input type="checkbox" value="2"><span>Tue</span></label>
                                    <label><input type="checkbox" value="3"><span>Wed</span></label>
                                    <label><input type="checkbox" value="4"><span>Thu</span></label>
                                    <label><input type="checkbox" value="5"><span>Fri</span></label>
                                    <label><input type="checkbox" value="6"><span>Sat</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group button-group">
                    <button type="submit" class="btn btn-primary">Save Task</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTask(currentTaskId)" style="display: none" id="delete-task-btn">Delete Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add this new modal for settings -->
    <div id="settings-modal" class="modal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select" onchange="changeTheme(this.value)">
                        <option value="system">Device Default</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Add this new modal for task details -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Task Details</h2>
                <button class="close-modal" onclick="closeTaskDetails()">&times;</button>
            </div>
            <div class="task-details-content">
                <div class="task-main-info">
                    <div class="task-title-section">
                        <input type="text" id="detail-title" class="title-input">
                        <div class="task-actions">
                            <button class="btn btn-danger" onclick="deleteTask(currentTaskId)">Delete Task</button>
                        </div>
                    </div>
                    <textarea id="detail-description" class="description-input"></textarea>
                    <div class="date-section">
                        <i class="far fa-calendar"></i>
                        <input type="text" id="detail-due-date" class="flatpickr">
                    </div>
                </div>

                <div class="recurring-section">
                    <div class="recurring-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="detail-is-recurring" onchange="toggleDetailRecurringOptions()">
                            <span class="checkbox-text">Make this task recurring</span>
                        </label>
                        <div id="detail-recurring-details" class="recurring-details" style="display: none;">
                            <div class="recurring-type">
                                <select id="detail-recurring-type" onchange="handleDetailRecurringTypeChange()">
                                    <option value="daily">Every Day</option>
                                    <option value="weekly">Every Week</option>
                                    <option value="monthly">Every Month</option>
                                </select>
                            </div>
                            
                            <div id="detail-monthly-options" class="monthly-selector" style="display: none;">
                                <select id="detail-monthly-day"></select>
                            </div>

                            <div id="detail-weekly-options" class="weekday-selector" style="display: none;">
                                <div class="weekday-buttons">
                                    <label><input type="checkbox" value="0"><span>Sun</span></label>
                                    <label><input type="checkbox" value="1"><span>Mon</span></label>
                                    <label><input type="checkbox" value="2"><span>Tue</span></label>
                                    <label><input type="checkbox" value="3"><span>Wed</span></label>
                                    <label><input type="checkbox" value="4"><span>Thu</span></label>
                                    <label><input type="checkbox" value="5"><span>Fri</span></label>
                                    <label><input type="checkbox" value="6"><span>Sat</span></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="subtasks-section">
                    <h3>Subtasks</h3>
                    <div id="detail-subtasks" class="subtasks-list">
                        <!-- Subtasks will be added here -->
                    </div>
                    <button class="btn btn-secondary" onclick="addSubtaskInDetails()">
                        <i class="fas fa-plus"></i> Add Subtask
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="status-message"></div>

    <script>
        // Initialize Appwrite
        const client = new Appwrite.Client()
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject('6786fe750018c76b54f3');

        const account = new Appwrite.Account(client);
        const databases = new Appwrite.Databases(client);
        const functions = new Appwrite.Functions(client);

        const databaseId = 'ideas-tracker';
        const collectionId = 'ideas-tracker';

        let currentUser = null;
        let currentTaskId = null;
        let flatpickrInstance;
        let detailsFlatpickr;

        // Initialize date picker
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the add task date picker
            window.addTaskFlatpickr = initializeDatePicker("due-date", new Date());
            
            // Initialize the details date picker
            window.detailsFlatpickr = initializeDatePicker("detail-due-date");

            // Generate monthly days on load
            generateMonthlyDays();
            
            // Check authentication
            checkAuth();
        });

        async function checkAuth() {
            try {
                currentUser = await account.get();
                if (!currentUser) {
                    throw new Error('No user found');
                }
                console.log('User authenticated:', currentUser);
                await handleRecurringTasks();
                loadTasks();
            } catch (error) {
                console.error('Authentication error:', error);
                if (error.code === 401) {
                    window.location.href = 'index.html';
                } else {
                    showMessage('Error checking authentication: ' + error.message, 'error');
                }
            }
        }

        function openAddTaskModal() {
            document.getElementById('task-modal').style.display = 'block';
            document.getElementById('modal-title').textContent = 'Add New Task';
            document.getElementById('task-form').reset();
            currentTaskId = null;
            
            // Initialize flatpickr if it doesn't exist
            if (!window.addTaskFlatpickr) {
                window.addTaskFlatpickr = flatpickr("#due-date", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                    minDate: 'today',
                    defaultDate: new Date()
                });
            } else {
                window.addTaskFlatpickr.clear();
            }
            
            resetSubtasks();
            generateMonthlyDays();
        }

        function closeModal() {
            document.getElementById('task-modal').style.display = 'none';
        }

        function resetSubtasks() {
            const container = document.getElementById('subtasks-container');
            container.innerHTML = '';
            addSubtask(); // Add one empty subtask by default
        }

        function addSubtask(value = '') {
            const container = document.getElementById('subtasks-container');
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'subtask-item';
            subtaskDiv.innerHTML = `
                <input type="checkbox" ${value.completed ? 'checked' : ''}>
                <input type="text" value="${value.text || ''}" placeholder="Enter subtask">
                <button type="button" class="btn btn-danger" onclick="removeSubtask(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            // Add event listener for checkbox
            const checkbox = subtaskDiv.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', () => {
                subtaskDiv.classList.toggle('completed', checkbox.checked);
            });

            container.appendChild(subtaskDiv);
            subtaskDiv.querySelector('input[type="text"]').focus();
        }

        function removeSubtask(button) {
            const subtaskDiv = button.parentElement;
            subtaskDiv.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => subtaskDiv.remove(), 300);
        }

        async function handleTaskSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const dueDate = window.addTaskFlatpickr.selectedDates[0];
            const isRecurring = document.getElementById('is-recurring').checked;
            const recurringType = isRecurring ? [document.getElementById('recurring-type').value] : [];
            
            const monthlyDay = (isRecurring && document.getElementById('recurring-type').value === 'monthly') 
                ? parseInt(document.getElementById('monthly-day').value)
                : null;
            
            const recurringWeekDays = (isRecurring && document.getElementById('recurring-type').value === 'weekly')
                ? Array.from(document.querySelectorAll('#weekly-options input:checked'))
                    .map(cb => cb.value)
                : [];

            const subtasks = Array.from(document.querySelectorAll('#subtasks-container .subtask-item'))
                .map(item => {
                    const text = item.querySelector('input[type="text"]').value.trim();
                    const completed = item.querySelector('input[type="checkbox"]').checked;
                    return text ? `${text}|${completed}` : null;
                })
                .filter(Boolean);

            const taskData = {
                userId: currentUser.$id,
                title: title,
                description: description || '',
                dueDate: dueDate ? dueDate.toISOString() : null,
                subtasks: subtasks,
                completed: false,
                createdAt: new Date().toISOString(),
                isRecurring: isRecurring,
                recurringType: recurringType,
                recurringWeekDays: recurringWeekDays,
                monthlyDay: monthlyDay
            };

            try {
                // Optimistically update UI
                closeModal();
                const tempId = 'temp-' + Date.now();
                
                if (currentTaskId) {
                    // Update existing task
                    const taskElement = document.querySelector(`[data-task-id="${currentTaskId}"]`);
                    if (taskElement) {
                        const updatedTaskElement = createTaskCard({ ...taskData, $id: currentTaskId });
                        taskElement.replaceWith(updatedTaskElement);
                    }
                    showMessage('Task updated successfully!', 'success');
                    
                    // Then update backend
                    await databases.updateDocument(databaseId, collectionId, currentTaskId, taskData);
                } else {
                    // Create new task
                    const tempTaskElement = createTaskCard({ ...taskData, $id: tempId });
                    document.getElementById('active-tasks').appendChild(tempTaskElement);
                    showMessage('Task added successfully!', 'success');
                    
                    // Then update backend
                    const response = await databases.createDocument(databaseId, collectionId, Appwrite.ID.unique(), taskData);
                    
                    // Update the temporary element with the real ID
                    const tempElement = document.querySelector(`[data-task-id="${tempId}"]`);
                    if (tempElement) {
                        tempElement.setAttribute('data-task-id', response.$id);
                        tempElement.querySelector('.task-checkbox').onclick = (e) => {
                            e.stopPropagation();
                            toggleTaskComplete(response.$id, !response.completed);
                        };
                        tempElement.querySelector('.delete-task-btn').onclick = (e) => {
                            e.stopPropagation();
                            deleteTask(response.$id);
                        };
                    }
                }
            } catch (error) {
                console.error('Error saving task:', error);
                showMessage('Error: ' + error.message, 'error');
                
                // Revert optimistic update
                if (!currentTaskId) {
                    const tempElement = document.querySelector(`[data-task-id="${tempId}"]`);
                    if (tempElement) tempElement.remove();
                }
                loadTasks(); // Reload to ensure consistency
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const taskDate = new Date(date);
            const diffTime = Math.abs(taskDate - now);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const isPast = taskDate < now;
            
            // Handle past dates
            if (isPast) {
                if (diffDays === 1) return '1 day ago';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 14) return '1 week ago';
                if (diffDays < 30) return `${Math.floor(diffDays/7)} weeks ago`;
                if (diffDays < 60) return '1 month ago';
                if (diffDays < 365) return `${Math.floor(diffDays/30)} months ago`;
                if (diffDays < 730) return '1 year ago';
                return `${Math.floor(diffDays/365)} years ago`;
            }
            
            // Handle future dates
            if (diffDays === 1) return 'in 1 day';
            if (diffDays < 7) return `in ${diffDays} days`;
            if (diffDays < 14) return 'in 1 week';
            if (diffDays < 30) return `in ${Math.floor(diffDays/7)} weeks`;
            if (diffDays < 60) return 'in 1 month';
            if (diffDays < 365) return `in ${Math.floor(diffDays/30)} months`;
            if (diffDays < 730) return 'in 1 year';
            return `in ${Math.floor(diffDays/365)} years`;
        }

        // Update the loadTasks function
        let isInitialLoad = true;

        async function loadTasks() {
            if (isInitialLoad) {
                showLoading();
            }
            try {
                const execution = await functions.createExecution(
                    '678c504c002d388d77df',
                    '', 
                    false
                );
                console.log('Function response:', execution);

                const response = await databases.listDocuments(databaseId, collectionId, [
                    Appwrite.Query.equal('userId', currentUser.$id)
                ]);

                const activeTasks = document.getElementById('active-tasks');
                const completedTasks = document.getElementById('completed-tasks');
                activeTasks.innerHTML = '';
                completedTasks.innerHTML = '';

                response.documents.forEach(task => {
                    const taskElement = createTaskCard(task);
                    if (task.completed) {
                        completedTasks.appendChild(taskElement);
                    } else {
                        activeTasks.appendChild(taskElement);
                    }
                });
            } catch (error) {
                console.error('Function error:', error);
                if (error.code === 401) {
                    redirectToLogin();
                } else {
                    showMessage('Error loading tasks: ' + error.message, 'error');
                }
            } finally {
                if (isInitialLoad) {
                    hideLoading();
                    isInitialLoad = false;
                }
            }
        }

        function createTaskCard(task) {
            const taskElement = document.createElement('div');
            taskElement.className = `task-card ${task.completed ? 'completed' : ''}`;
            taskElement.setAttribute('data-task-id', task.$id);
            
            // Parse subtasks and count completed ones
            const subtasks = task.subtasks?.map(st => {
                const [text, completed] = st.split('|');
                return { text, completed: completed === 'true' };
            }) || [];
            const completedSubtasks = subtasks.filter(st => st.completed).length;
            
            taskElement.innerHTML = `
                <div class="task-content" onclick="openTaskDetails('${task.$id}')">
                    <div class="title">${task.title}</div>
                    <div class="meta">
                        <span class="due-date">
                            <i class="${task.isRecurring ? 'fas fa-sync-alt' : 'far fa-calendar'}"></i>
                            ${task.dueDate ? formatTimeAgo(task.dueDate) : 'No due date'}
                        </span>
                        ${subtasks.length > 0 ? `
                            <span class="subtasks">
                                <i class="far fa-square"></i>
                                ${completedSubtasks}/${subtasks.length}
                            </span>
                        ` : ''}
                    </div>
                </div>
                <div class="task-actions">
                    <input type="checkbox" 
                        class="task-checkbox" 
                        ${task.completed ? 'checked' : ''} 
                        onclick="event.stopPropagation(); toggleTaskComplete('${task.$id}')"
                    >
                    <button class="delete-task-btn" onclick="event.stopPropagation(); deleteTask('${task.$id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            return taskElement;
        }

        async function openTaskDetails(taskId) {
            try {
                if (!taskId) return;
                
                const task = await databases.getDocument(databaseId, collectionId, taskId);
                currentTaskId = taskId;
                
                // Initialize or update the details flatpickr
                if (!window.detailsFlatpickr) {
                    window.detailsFlatpickr = flatpickr("#detail-due-date", {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        time_24hr: true,
                        minDate: 'today'
                    });
                }

                // Populate task details
                document.getElementById('detail-title').value = task.title;
                document.getElementById('detail-description').value = task.description || '';
                
                if (task.dueDate) {
                    window.detailsFlatpickr.setDate(new Date(task.dueDate));
                } else {
                    window.detailsFlatpickr.clear();
                }

                // Populate recurring options
                const isRecurringCheckbox = document.getElementById('detail-is-recurring');
                const recurringDetails = document.getElementById('detail-recurring-details');
                isRecurringCheckbox.checked = task.isRecurring;
                recurringDetails.style.display = task.isRecurring ? 'block' : 'none';
                
                if (task.isRecurring) {
                    const recurringType = task.recurringType?.[0] || 'daily';
                    document.getElementById('detail-recurring-type').value = recurringType;
                    
                    // Handle weekly options
                    document.getElementById('detail-weekly-options').style.display = recurringType === 'weekly' ? 'block' : 'none';
                    if (recurringType === 'weekly') {
                        document.querySelectorAll('#detail-weekly-options input[type="checkbox"]').forEach(cb => {
                            cb.checked = task.recurringWeekDays?.includes(cb.value) || false;
                        });
                    }
                    
                    // Handle monthly options
                    document.getElementById('detail-monthly-options').style.display = recurringType === 'monthly' ? 'block' : 'none';
                    if (recurringType === 'monthly') {
                        generateMonthlyDays('detail-monthly-day');
                        const monthlyDay = task.monthlyDay || (task.dueDate ? new Date(task.dueDate).getDate() : 1);
                        document.getElementById('detail-monthly-day').value = monthlyDay;
                    }
                }

                // Populate subtasks
                const subtasksList = document.getElementById('detail-subtasks');
                subtasksList.innerHTML = '';
                if (task.subtasks?.length) {
                    task.subtasks.forEach((subtask, index) => {
                        addSubtaskToDetails(subtask, index);
                    });
                }
                
                document.getElementById('task-details-modal').style.display = 'block';
                addTaskDetailsListeners();

            } catch (error) {
                console.error('Error opening task details:', error);
                showMessage('Error loading task details: ' + error.message, 'error');
            }
        }

        function addSubtaskToDetails(subtaskString = '', index) {
            const container = document.getElementById('detail-subtasks');
            const [text = '', completed = false] = subtaskString.split('|');
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = `detail-subtask-item ${completed === 'true' ? 'completed' : ''}`;
            subtaskDiv.innerHTML = `
                <input type="checkbox" ${completed === 'true' ? 'checked' : ''}>
                <input type="text" value="${text}" placeholder="Enter subtask">
                <button class="btn btn-danger">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            // Add event listeners
            const checkbox = subtaskDiv.querySelector('input[type="checkbox"]');
            const textInput = subtaskDiv.querySelector('input[type="text"]');
            const deleteBtn = subtaskDiv.querySelector('.btn-danger');

            checkbox.addEventListener('change', () => {
                // Optimistically update UI
                const wasCompleted = subtaskDiv.classList.contains('completed');
                subtaskDiv.classList.toggle('completed', !wasCompleted);
                checkbox.checked = !wasCompleted;
                
                // Then save changes
                saveTaskChanges().catch(() => {
                    // Revert on error
                    subtaskDiv.classList.toggle('completed', wasCompleted);
                    checkbox.checked = wasCompleted;
                });
            });
            
            textInput.addEventListener('input', debounce(() => saveTaskChanges(), 500));
            
            deleteBtn.addEventListener('click', () => {
                // Optimistically remove subtask
                subtaskDiv.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    subtaskDiv.remove();
                    saveTaskChanges().catch(() => {
                        // Revert on error
                        subtaskDiv.style.animation = '';
                        container.appendChild(subtaskDiv);
                    });
                }, 300);
            });

            container.appendChild(subtaskDiv);
            textInput.focus();
        }

        function updateSubtask(index, completed = null, text = null) {
            const task = currentTask;
            if (!task.subtasks) task.subtasks = [];
            
            if (completed !== null) {
                task.subtasks[index].completed = completed;
            }
            if (text !== null) {
                task.subtasks[index].text = text;
            }
            
            saveTaskChanges();
        }

        function removeSubtask(index) {
            const task = currentTask;
            task.subtasks.splice(index, 1);
            saveTaskChanges();
        }

        async function saveTaskChanges() {
            if (!currentTaskId) return;
            
            const isRecurringCheckbox = document.getElementById('detail-is-recurring');
            const recurringTypeSelect = document.getElementById('detail-recurring-type');
            
            const isRecurring = isRecurringCheckbox?.checked || false;
            const recurringType = isRecurring && recurringTypeSelect ? [recurringTypeSelect.value] : [];
            
            let monthlyDay = null;
            if (isRecurring && recurringTypeSelect?.value === 'monthly') {
                const monthlyDaySelect = document.getElementById('detail-monthly-day');
                if (monthlyDaySelect) {
                    monthlyDay = parseInt(monthlyDaySelect.value);
                }
            }

            const subtasks = Array.from(document.querySelectorAll('#detail-subtasks .detail-subtask-item'))
                .map(item => {
                    const text = item.querySelector('input[type="text"]').value.trim();
                    const completed = item.querySelector('input[type="checkbox"]').checked;
                    return text ? `${text}|${completed}` : null;
                })
                .filter(Boolean);

            const taskData = {
                title: document.getElementById('detail-title')?.value || '',
                description: document.getElementById('detail-description')?.value || '',
                dueDate: window.detailsFlatpickr?.selectedDates[0]?.toISOString(),
                isRecurring: isRecurring,
                recurringType: recurringType,
                recurringWeekDays: Array.from(document.querySelectorAll('#detail-weekly-options input:checked'))
                    .map(cb => cb.value),
                monthlyDay: monthlyDay,
                subtasks: subtasks
            };

            try {
                // Optimistically update the task card in the list if it exists
                const taskCard = document.querySelector(`[data-task-id="${currentTaskId}"]`);
                if (taskCard) {
                    const titleElement = taskCard.querySelector('.title');
                    const dueDateElement = taskCard.querySelector('.due-date');
                    const subtasksElement = taskCard.querySelector('.subtasks');
                    
                    if (titleElement) {
                        titleElement.textContent = taskData.title;
                    }
                    
                    if (dueDateElement) {
                        dueDateElement.innerHTML = `
                            <i class="${taskData.isRecurring ? 'fas fa-sync-alt' : 'far fa-calendar'}"></i>
                            ${taskData.dueDate ? formatTimeAgo(taskData.dueDate) : 'No due date'}
                        `;
                    }
                    
                    if (subtasksElement && subtasks.length > 0) {
                        const completedSubtasks = subtasks.filter(st => st.split('|')[1] === 'true').length;
                        subtasksElement.innerHTML = `
                            <i class="far fa-check-square"></i>
                            ${completedSubtasks}/${subtasks.length}
                        `;
                    }
                }

                await databases.updateDocument(databaseId, collectionId, currentTaskId, taskData);
            } catch (error) {
                console.error('Error saving task:', error);
                showMessage('Error saving task: ' + error.message, 'error');
                // Revert optimistic update by reloading tasks
                loadTasks();
            }
        }

        async function toggleTaskComplete(taskId) {
            try {
                event?.preventDefault();
                event?.stopPropagation();

                // Store the task element before any changes
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (!taskElement) return;

                // Get the checkbox element
                const checkbox = taskElement.querySelector('.task-checkbox');
                if (!checkbox) return;

                // Store the current state before making changes
                const wasCompleted = taskElement.classList.contains('completed');
                const newCompleted = !wasCompleted;

                // Optimistically update the UI
                taskElement.classList.toggle('completed', newCompleted);
                checkbox.checked = newCompleted;

                if (newCompleted) {
                    createConfetti();
                    const completedContainer = document.getElementById('completed-tasks');
                    completedContainer.appendChild(taskElement);
                } else {
                    const activeContainer = document.getElementById('active-tasks');
                    activeContainer.appendChild(taskElement);
                }

                showMessage(`Task marked as ${newCompleted ? 'completed' : 'active'}!`, 'success');

                // Then update the backend
                await databases.updateDocument(databaseId, collectionId, taskId, { 
                    completed: newCompleted 
                });
            } catch (error) {
                // Revert the UI if the backend update fails
                if (taskElement) {
                    taskElement.classList.toggle('completed', wasCompleted);
                    checkbox.checked = wasCompleted;
                    
                    if (wasCompleted) {
                        const completedContainer = document.getElementById('completed-tasks');
                        completedContainer.appendChild(taskElement);
                    } else {
                        const activeContainer = document.getElementById('active-tasks');
                        activeContainer.appendChild(taskElement);
                    }
                }
                
                if (error.code === 401) {
                    redirectToLogin();
                } else {
                    showMessage('Error updating task: ' + error.message, 'error');
                }
            }
        }

        // Add confetti functions
        function createConfetti() {
            const colors = ['#34d399', '#059669', '#10b981', '#6ee7b7', '#a7f3d0'];
            const container = document.getElementById('confetti-container');
            const confettiCount = 50;

            // Clear any existing confetti
            container.innerHTML = '';

            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 8 + 6) + 'px';
                confetti.style.height = (Math.random() * 8 + 6) + 'px';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                // Randomly make some confetti pieces different shapes
                if (Math.random() > 0.6) {
                    confetti.style.borderRadius = '50%';
                } else if (Math.random() > 0.3) {
                    confetti.style.borderRadius = '2px';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg) skew(${Math.random() * 25}deg)`;
                }

                container.appendChild(confetti);
                
                // Add the active class after a small delay to trigger the animation
                setTimeout(() => {
                    confetti.classList.add('active');
                }, 0);
            }

            // Clean up confetti after animation
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        async function deleteTask(taskId) {
            try {
                event?.preventDefault();
                event?.stopPropagation();
                
                // Optimistically update UI
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => taskElement.remove(), 300);
                }
                showMessage('Task deleted successfully!', 'success');
                closeModal();
                closeTaskDetails();

                // Then update backend
                await databases.deleteDocument(databaseId, collectionId, taskId);
            } catch (error) {
                // Revert UI if backend update fails
                if (taskElement) {
                    taskElement.style.animation = '';
                    taskElement.style.display = 'flex';
                }
                
                if (error.code === 401) {
                    redirectToLogin();
                } else {
                    showMessage('Error deleting task: ' + error.message, 'error');
                }
            }
        }

        function showMessage(message, type) {
            const statusElement = document.getElementById('status-message');
            statusElement.innerHTML = message;
            statusElement.className = type;
            statusElement.style.display = 'block';
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'block';
            // Load saved settings
            const savedTheme = localStorage.getItem('theme') || 'system';
            document.getElementById('theme-select').value = savedTheme;
            const savedView = localStorage.getItem('defaultView') || 'all';
            document.getElementById('default-view').value = savedView;
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function toggleRecurringOptions() {
            const isRecurring = document.getElementById('is-recurring').checked;
            const recurringDetails = document.getElementById('recurring-details');
            recurringDetails.style.display = isRecurring ? 'block' : 'none';
            
            // Handle calendar disabling
            if (window.addTaskFlatpickr) {
                const calendar = window.addTaskFlatpickr.calendarContainer;
                if (calendar) {
                    if (isRecurring) {
                        calendar.classList.add('disabled');
                        // Set initial date based on recurring type
                        const recurringType = document.getElementById('recurring-type').value;
                        updateRecurringDate(recurringType);
                    } else {
                        calendar.classList.remove('disabled');
                    }
                }
            }
        }

        function updateRecurringDate(type) {
            const today = new Date();
            let nextDate = new Date(today);
            
            switch(type) {
                case 'daily':
                    // Set to tomorrow
                    nextDate.setDate(today.getDate() + 1);
                    break;
                    
                case 'weekly':
                    const selectedWeekdays = Array.from(document.querySelectorAll('#weekly-options input:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedWeekdays.length > 0) {
                        const currentDay = today.getDay();
                        const nextDay = selectedWeekdays.find(day => day > currentDay) || selectedWeekdays[0];
                        const daysToAdd = nextDay > currentDay ? nextDay - currentDay : 7 - currentDay + nextDay;
                        nextDate.setDate(today.getDate() + daysToAdd);
                    }
                    break;
                    
                case 'monthly':
                    const monthlyDay = parseInt(document.getElementById('monthly-day').value);
                    nextDate.setDate(monthlyDay);
                    // If the day has already passed this month, move to next month
                    if (nextDate < today) {
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    }
                    break;
            }
            
            if (window.addTaskFlatpickr) {
                window.addTaskFlatpickr.setDate(nextDate);
            }
        }

        // Add event listeners for recurring options
        document.getElementById('recurring-type').addEventListener('change', function(e) {
            const weeklyOptions = document.getElementById('weekly-options');
            const monthlyOptions = document.getElementById('monthly-options');
            
            weeklyOptions.style.display = e.target.value === 'weekly' ? 'block' : 'none';
            monthlyOptions.style.display = e.target.value === 'monthly' ? 'block' : 'none';

            updateRecurringDate(e.target.value);
        });

        // Add event listeners for weekly checkboxes
        document.querySelectorAll('#weekly-options input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', () => {
                if (document.getElementById('is-recurring').checked) {
                    updateRecurringDate('weekly');
                }
            });
        });

        // Add event listener for monthly day select
        document.getElementById('monthly-day').addEventListener('change', () => {
            if (document.getElementById('is-recurring').checked) {
                updateRecurringDate('monthly');
            }
        });

        // Update the details view recurring options
        function toggleDetailRecurringOptions() {
            const isRecurring = document.getElementById('detail-is-recurring').checked;
            const recurringDetails = document.getElementById('detail-recurring-details');
            recurringDetails.style.display = isRecurring ? 'block' : 'none';
            
            if (window.detailsFlatpickr) {
                const calendar = window.detailsFlatpickr.calendarContainer;
                if (calendar) {
                    if (isRecurring) {
                        calendar.classList.add('disabled');
                        // Set initial date based on recurring type
                        const recurringType = document.getElementById('detail-recurring-type').value;
                        updateDetailRecurringDate(recurringType);
                    } else {
                        calendar.classList.remove('disabled');
                    }
                }
            }
        }

        function updateDetailRecurringDate(type) {
            const today = new Date();
            let nextDate = new Date(today);
            
            switch(type) {
                case 'daily':
                    // Set to tomorrow
                    nextDate.setDate(today.getDate() + 1);
                    break;
                    
                case 'weekly':
                    const selectedWeekdays = Array.from(document.querySelectorAll('#detail-weekly-options input:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedWeekdays.length > 0) {
                        const currentDay = today.getDay();
                        const nextDay = selectedWeekdays.find(day => day > currentDay) || selectedWeekdays[0];
                        const daysToAdd = nextDay > currentDay ? nextDay - currentDay : 7 - currentDay + nextDay;
                        nextDate.setDate(today.getDate() + daysToAdd);
                    }
                    break;
                    
                case 'monthly':
                    const monthlyDay = parseInt(document.getElementById('detail-monthly-day').value);
                    nextDate.setDate(monthlyDay);
                    // If the day has already passed this month, move to next month
                    if (nextDate < today) {
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    }
                    break;
            }
            
            if (window.detailsFlatpickr) {
                window.detailsFlatpickr.setDate(nextDate);
            }
        }

        function handleDetailRecurringTypeChange() {
            const type = document.getElementById('detail-recurring-type').value;
            document.getElementById('detail-weekly-options').style.display = type === 'weekly' ? 'block' : 'none';
            document.getElementById('detail-monthly-options').style.display = type === 'monthly' ? 'block' : 'none';
            
            if (document.getElementById('detail-is-recurring').checked) {
                updateDetailRecurringDate(type);
            }
            
            saveTaskChanges();
        }

        // Add event listeners for detail weekly checkboxes
        document.querySelectorAll('#detail-weekly-options input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', () => {
                if (document.getElementById('detail-is-recurring').checked) {
                    updateDetailRecurringDate('weekly');
                }
                saveTaskChanges();
            });
        });

        // Add event listener for detail monthly day select
        document.getElementById('detail-monthly-day').addEventListener('change', () => {
            if (document.getElementById('detail-is-recurring').checked) {
                updateDetailRecurringDate('monthly');
            }
            handleMonthlyDayChange();
        });

        // Initialize the page
        window.onload = function() {
            checkAuth();
            initializeTheme();
        };

        // Add this function to check session before redirecting
        function redirectToLogin() {
            localStorage.removeItem('sessionActive');
            window.location.href = 'index.html';
        }

        // Add event listener to handle clicks
        document.addEventListener('click', async function(event) {
            // Prevent default only for specific buttons
            if (event.target.matches('.task-checkbox') || 
                event.target.matches('.delete-task-btn') || 
                event.target.matches('.restore-btn')) {
                event.preventDefault();
            }
        });

        // Update the logout function
        async function logout() {
            try {
                await account.deleteSession('current');
                window.location.href = 'index.html'; // Redirect to login page
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function handleRecurringTypeChange() {
            const type = document.getElementById('recurring-type').value;
            const weeklyOptions = document.getElementById('weekly-options');
            const monthlyOptions = document.getElementById('monthly-options');
            
            weeklyOptions.style.display = type === 'weekly' ? 'block' : 'none';
            monthlyOptions.style.display = type === 'monthly' ? 'block' : 'none';

            if (type === 'monthly') {
                handleMonthlyDayChange();
            } else if (type === 'weekly') {
                const selectedWeekdays = Array.from(document.querySelectorAll('#weekly-options input:checked'))
                    .map(cb => parseInt(cb.value));
                if (selectedWeekdays.length > 0) {
                    const today = new Date();
                    const currentDay = today.getDay();
                    const nextDay = selectedWeekdays.find(day => day >= currentDay) || selectedWeekdays[0];
                    const daysToAdd = nextDay >= currentDay ? nextDay - currentDay : 7 - currentDay + nextDay;
                    const nextDate = new Date(today);
                    nextDate.setDate(today.getDate() + daysToAdd);
                    
                    if (window.detailsFlatpickr) {
                        window.detailsFlatpickr.setDate(nextDate);
                    }
                }
            }
        }

        function getDaySuffix(day) {
            if (day >= 11 && day <= 13) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        // Update the generateMonthlyDays function
        function generateMonthlyDays(elementId = 'monthly-day') {
            const monthlySelect = document.getElementById(elementId);
            if (!monthlySelect) return;
            
            // Store current value before clearing
            const currentValue = monthlySelect.value;
            
            monthlySelect.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}${getDaySuffix(i)}`;
                monthlySelect.appendChild(option);
            }
            
            // Restore the selected value
            if (currentValue) {
                monthlySelect.value = currentValue;
            }
        }

        // Add function to close task details modal
        function closeTaskDetails() {
            document.getElementById('task-details-modal').style.display = 'none';
        }

        function addTaskDetailsListeners() {
            // Auto-save title changes
            document.getElementById('detail-title').addEventListener('input', debounce(() => saveTaskChanges(), 500));

            // Auto-save description changes
            document.getElementById('detail-description').addEventListener('input', debounce(() => saveTaskChanges(), 500));

            // Auto-save date changes
            if (window.detailsFlatpickr) {
                window.detailsFlatpickr.config.onChange = [() => saveTaskChanges()];
            }

            // Add listeners for recurring options
            document.getElementById('detail-recurring-type').addEventListener('change', handleDetailRecurringTypeChange);
            
            // Add listeners for weekly checkboxes
            document.querySelectorAll('#detail-weekly-options input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', () => saveTaskChanges());
            });
            
            // Add listener for monthly day select
            document.getElementById('detail-monthly-day').addEventListener('change', handleMonthlyDayChange);
        }

        // Add debounce function to prevent too many saves
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleDetailRecurringOptions() {
            const isRecurring = document.getElementById('detail-is-recurring').checked;
            const recurringDetails = document.getElementById('detail-recurring-details');
            recurringDetails.style.display = isRecurring ? 'block' : 'none';
            
            if (window.detailsFlatpickr) {
                const calendar = window.detailsFlatpickr.calendarContainer;
                if (calendar) {
                    if (isRecurring) {
                        calendar.classList.add('disabled');
                    } else {
                        calendar.classList.remove('disabled');
                    }
                }
            }

            if (isRecurring) {
                handleRecurringTypeChange();
            }
        }

        function handleDetailRecurringTypeChange() {
            const type = document.getElementById('detail-recurring-type').value;
            document.getElementById('detail-weekly-options').style.display = type === 'weekly' ? 'block' : 'none';
            document.getElementById('detail-monthly-options').style.display = type === 'monthly' ? 'block' : 'none';
            
            // Reset and update monthly day if needed
            if (type === 'monthly') {
                const currentDate = window.detailsFlatpickr.selectedDates[0];
                const monthlyDay = currentDate.getDate();
                document.getElementById('detail-monthly-day').value = monthlyDay;
            }
            
            saveTaskChanges();
        }

        function addSubtaskInDetails() {
            const container = document.getElementById('detail-subtasks');
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'detail-subtask-item';
            subtaskDiv.innerHTML = `
                <input type="checkbox">
                <input type="text" value="" placeholder="Enter subtask">
                <button class="btn btn-danger">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            // Add event listeners
            const checkbox = subtaskDiv.querySelector('input[type="checkbox"]');
            const textInput = subtaskDiv.querySelector('input[type="text"]');
            const deleteBtn = subtaskDiv.querySelector('.btn-danger');

            checkbox.addEventListener('change', () => {
                subtaskDiv.classList.toggle('completed', checkbox.checked);
                saveTaskChanges();
            });
            
            textInput.addEventListener('input', debounce(() => saveTaskChanges(), 500));
            
            deleteBtn.addEventListener('click', () => {
                subtaskDiv.remove();
                saveTaskChanges();
            });

            container.appendChild(subtaskDiv);
            textInput.focus();
        }

        // Add these functions for theme management
        function initializeTheme() {
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                document.getElementById('theme-select').value = savedTheme;
            } else {
                // Check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.getElementById('theme-select').value = 'dark';
                }
            }

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (document.getElementById('theme-select').value === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            });
        }

        function changeTheme(value) {
            if (value === 'system') {
                // Use system preference
                const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', value);
            }
            localStorage.setItem('theme', value);
        }

        // Clean handleMonthlyDayChange function
        function handleMonthlyDayChange() {
            const monthlyDaySelect = document.getElementById('detail-monthly-day');
            if (!monthlyDaySelect) return;

            const selectedDay = parseInt(monthlyDaySelect.value);
            const taskId = currentTaskId;

            // Update the task in the database with the new monthly day
            databases.updateDocument(databaseId, collectionId, taskId, {
                monthlyDay: selectedDay
            })
            .then(() => {
                showMessage('Monthly recurring day updated successfully!', 'success');
                
                // Also update the date picker to match
                if (window.detailsFlatpickr) {
                    const currentDate = window.detailsFlatpickr.selectedDates[0] || new Date();
                    const newDate = new Date(currentDate);
                    newDate.setDate(selectedDay);
                    window.detailsFlatpickr.setDate(newDate);
                }
            })
            .catch(error => {
                showMessage('Error updating monthly day: ' + error.message, 'error');
            });
        }

        // Add back the loading functions
        function showLoading() {
            document.getElementById('loading-screen').style.display = 'flex';
        }

        function hideLoading() {
            const loader = document.getElementById('loading-screen');
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                loader.style.opacity = '1';
            }, 300);
        }

        // Update the date picker initialization
        function initializeDatePicker(elementId, defaultDate = null) {
            const picker = flatpickr(`#${elementId}`, {
                enableTime: true,
                dateFormat: "H:i",
                time_24hr: true,
                defaultDate: defaultDate,
                minDate: 'today',
                noCalendar: false, // Will be toggled based on recurring state
                onChange: function(selectedDates, dateStr, instance) {
                    const selectedDate = selectedDates[0];
                    const now = new Date();
                    now.setSeconds(0, 0);
                    
                    const isRecurring = document.getElementById('detail-is-recurring')?.checked || 
                                       document.getElementById('is-recurring')?.checked;

                    if (isRecurring) {
                        // For recurring tasks, only update the time
                        const currentDate = instance._initialDate || new Date();
                        const newDate = new Date(currentDate);
                        newDate.setHours(selectedDate.getHours());
                        newDate.setMinutes(selectedDate.getMinutes());
                        
                        // Store the initial date if not already stored
                        if (!instance._initialDate) {
                            instance._initialDate = new Date(currentDate);
                        }
                        
                        instance.setDate(newDate);
                        return;
                    }

                    // For non-recurring tasks, handle as before
                    if (selectedDate < now) {
                        instance.setDate(now);
                        showMessage('Cannot select past dates', 'error');
                    }
                },
                onOpen: function(selectedDates, dateStr, instance) {
                    const isRecurring = document.getElementById('detail-is-recurring')?.checked || 
                                       document.getElementById('is-recurring')?.checked;
                    
                    if (isRecurring) {
                        // Switch to time-only mode for recurring tasks
                        instance.set('noCalendar', true);
                        instance.set('dateFormat', "H:i");
                        
                        // Store current date when opening
                        instance._initialDate = instance._initialDate || new Date(instance.selectedDates[0]);
                        
                        // Add class for time-only styling
                        instance.calendarContainer.classList.add('time-only-picker');
                    } else {
                        // Switch back to full calendar mode
                        instance.set('noCalendar', false);
                        instance.set('dateFormat', "Y-m-d H:i");
                        instance.calendarContainer.classList.remove('time-only-picker');
                    }
                }
            });
            return picker;
        }

        // Update the add task form initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the add task date picker
            window.addTaskFlatpickr = flatpickr("#due-date", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                time_24hr: true,
                minDate: 'today',
                defaultDate: new Date(),
                onChange: function(selectedDates, dateStr, instance) {
                    const selectedDate = selectedDates[0];
                    const now = new Date();
                    now.setSeconds(0, 0);
                    
                    // Prevent selecting past dates
                    if (selectedDate < now) {
                        instance.setDate(now);
                        showMessage('Cannot select past dates', 'error');
                        return;
                    }

                    const isRecurring = document.getElementById('is-recurring').checked;
                    const recurringType = document.getElementById('recurring-type').value;
                    
                    if (isRecurring) {
                        let validDate = new Date(selectedDate);
                        
                        switch (recurringType) {
                            case 'monthly':
                                const monthlyDay = parseInt(document.getElementById('monthly-day').value);
                                validDate.setDate(monthlyDay);
                                if (validDate < now) {
                                    validDate.setMonth(validDate.getMonth() + 1);
                                }
                                instance.setDate(validDate);
                                break;
                                
                            case 'weekly':
                                const selectedWeekdays = Array.from(document.querySelectorAll('#weekly-options input:checked'))
                                    .map(cb => parseInt(cb.value));
                                if (selectedWeekdays.length > 0) {
                                    const currentDay = validDate.getDay();
                                    if (!selectedWeekdays.includes(currentDay)) {
                                        const nextDay = selectedWeekdays.find(day => day > currentDay) ?? selectedWeekdays[0];
                                        const daysToAdd = nextDay > currentDay ? 
                                            nextDay - currentDay : 
                                            7 - currentDay + nextDay;
                                        validDate.setDate(validDate.getDate() + daysToAdd);
                                        instance.setDate(validDate);
                                    }
                                }
                                break;
                        }
                    }
                }
            });
        });

        // Add function to handle recurring tasks
        async function handleRecurringTasks() {
            try {
                const response = await databases.listDocuments(databaseId, collectionId, [
                    Appwrite.Query.equal('userId', currentUser.$id),
                    Appwrite.Query.equal('isRecurring', true)
                ]);

                for (const task of response.documents) {
                    if (!task.isRecurring) continue;

                    const today = new Date();
                    const dueDate = new Date(task.dueDate);
                    let shouldCreateNew = false;
                    let nextDueDate = new Date(dueDate);

                    switch (task.recurringType[0]) {
                        case 'daily':
                            if (dueDate < today) {
                                // Find next due date after today
                                while (nextDueDate < today) {
                                    nextDueDate.setDate(nextDueDate.getDate() + 1);
                                }
                                shouldCreateNew = true;
                            }
                            break;

                        case 'weekly':
                            if (dueDate < today && task.recurringWeekDays?.length) {
                                // Find the next occurrence after today
                                let found = false;
                                while (!found && nextDueDate <= today) {
                                    nextDueDate.setDate(nextDueDate.getDate() + 1);
                                    if (task.recurringWeekDays.includes(nextDueDate.getDay().toString())) {
                                        found = true;
                                        shouldCreateNew = true;
                                    }
                                }
                            }
                            break;

                        case 'monthly':
                            if (dueDate < today && task.monthlyDay) {
                                // Find next monthly occurrence
                                while (nextDueDate <= today) {
                                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                                    nextDueDate.setDate(task.monthlyDay);
                                }
                                shouldCreateNew = true;
                            }
                            break;
                    }

                    if (shouldCreateNew) {
                        // Create next occurrence and mark current as completed
                        await createRecurringTask(task, nextDueDate);
                        await databases.updateDocument(databaseId, collectionId, task.$id, {
                            completed: true
                        });
                    }
                }
            } catch (error) {
                console.error('Error handling recurring tasks:', error);
                showMessage('Error handling recurring tasks: ' + error.message, 'error');
            }
        }

        async function createRecurringTask(originalTask, nextDueDate) {
            const newTaskData = {
                userId: originalTask.userId,
                title: originalTask.title,
                description: originalTask.description,
                dueDate: nextDueDate.toISOString(),
                subtasks: originalTask.subtasks || [],
                completed: false,
                createdAt: new Date().toISOString(),
                isRecurring: originalTask.isRecurring,
                recurringType: originalTask.recurringType,
                recurringWeekDays: originalTask.recurringWeekDays,
                monthlyDay: originalTask.monthlyDay
            };

            try {
                await databases.createDocument(databaseId, collectionId, Appwrite.ID.unique(), newTaskData);
            } catch (error) {
                console.error('Error creating recurring task:', error);
                showMessage('Error creating recurring task: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html> 
